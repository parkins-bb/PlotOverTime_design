<p>曲线数据（时间历程）输出功能</p>
<h1 id="需求分析">需求分析</h1>
<h2 id="功能分析">功能分析</h2>
<ul>
<li>功能需求简单整理如下：</li>
</ul>
<ol type="1">
<li>输出指定set_id集合（可以是点/线/面/体，必须是存在的Subset）上的所有场信息；<br />
</li>
<li>输出指定set_id集合（可以是点/线/面/体）上的给定场信息；<br />
</li>
<li>输出指定若干id（点/线/面/体）上的所有场信息（统一按局部编号）；<br />
</li>
<li>输出指定若干id（点/线/面/体）上的给定场信息（统一按局部编号）；<br />
</li>
<li>输出除场信息外，需要默认包含一些元数据信息，如坐标、时间步、当前模拟时间;<br />
</li>
<li>输出参考量的时间历程（常量、函数等）;<br />
</li>
<li>输出控制（按时间步还是模拟时间等）；<br />
</li>
<li>根据指定几何坐标/boundingBox进行输出；（暂时不用考虑，基于前面的功能+空间搜索即可实现）</li>
</ol>
<ul>
<li>注意点：</li>
</ul>
<ol type="1">
<li>前2点根据subset输出，数据量较大，需要用二进制（hdf5）；<br />
</li>
<li>二进制要能被paraview读取，且方便用户选择点进行绘图；<br />
</li>
<li>从用户层考虑，最方便的是指定坐标范围输出，为了实现该功能首先需要满足需求3、4；<br />
</li>
<li>时刻注意网格等数据都是分布式并行的；<br />
</li>
<li>指定点输出考虑到量较小、且用户使用该接口意味着不想再在paraview中选点，故最好各点独自输出到单独文件；<br />
</li>
<li>set_id集合输出方式可能会有部分数据重复（点/线/面时，不包含ghost但仍有shared），可以暂时不用管（要处理的话可用sFaceId等变量筛选、只有owner能输出shared元素）；</li>
</ol>
<h2 id="性能需求">性能需求</h2>
<ul>
<li>各进程输出完全独立，只要代码实现不犯低级错误，性能不会差；</li>
</ul>
<h1 id="设计说明">设计说明</h1>
<h2 id="文件格式说明">文件格式说明</h2>
<ul>
<li>h5part</li>
</ul>
<p>采用h5part格式作为set_id集合输出的文件，主要优点： 1. HDF5，高效；2. 单文件； 3. paraview可视化支持。 目前生成h5part文件的代码有两种，参考test的<code>testH5Part</code>和<code>testH5Part2</code>案例，<strong>这里第一种采用的h5part工具的输出接口（代码已集成至hsf）；第二种是用hsf自己实现的hdf5输出写的，展示了如何将AOS转换为SOA</strong>，因为h5part要求必须为SOA，矢量场必须以各分量的形式输出。 该格式的结构如下：</p>
<pre><code>├── Step#0
│   ├── id
│   ├── x
│   ├── y
│   ├── z
│   └── ...  
│   
├── Step#10
│   
├── ...</code></pre>
<p>每个时间步有一个HDF Group，内部包含<code>id</code>、坐标与其他场变量，这些量均为1维数组，长度为各进程set_id元素个数的总和。（问题：模拟时间t能否加入该h5part文件的每个step，目前h5part代码似乎有WriteFieldAttrib的功能可用来做这个）</p>
<ul>
<li>csv</li>
</ul>
<p>该格式为个别点的输出服务，考虑到数据量不大，为了方便处理与可视化采用csv格式，示例如下：</p>
<pre><code>&quot;Point Coordinates:0&quot;,&quot;Point Coordinates:1&quot;,&quot;Point Coordinates:2&quot;,&quot;Time&quot;,&quot;acc_contact_force:0&quot;,&quot;acc_contact_force:1&quot;,&quot;acc_contact_force:2&quot;,&quot;applied_force:0&quot;,&quot;applied_force:1&quot;,&quot;applied_force:2&quot;,&quot;contatc_force:0&quot;,&quot;contatc_force:1&quot;,&quot;contatc_force:2&quot;,&quot;internal_force:0&quot;,&quot;internal_force:1&quot;,&quot;internal_force:2&quot;
-5.0288,-0.09704,-8.0209,0,0,0,0,0,0,0,0,0,0,0,0,0,
-4.9274,-0.09704,-8.0209,0.0020275,0,0,0,0,0,0,0,0,0,-2.1736e-06,1.643e-07,-1.0302e-07,
...</code></pre>
<p>命名可灵活调整，易懂就行，注意时间步和模拟时间数据都要有（示例可能不全）</p>
<h2 id="接口设计">接口设计</h2>
<h3 id="用户接口">用户接口</h3>
<p>（重要）</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">class</span> PlotOverTime { <span class="co">///该类只有一个实例</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">public</span>:</a>
<a class="sourceLine" id="cb3-3" title="3"></a>
<a class="sourceLine" id="cb3-4" title="4">  <span class="co">///输出目录名,Region中可获得网格及场数据</span></a>
<a class="sourceLine" id="cb3-5" title="5">  PlotOverTime(<span class="at">const</span> string &amp;dump_directory_name,Region* reg);</a>
<a class="sourceLine" id="cb3-6" title="6">  </a>
<a class="sourceLine" id="cb3-7" title="7">  <span class="kw">virtual</span> ~PlotOverTime();</a>
<a class="sourceLine" id="cb3-8" title="8"></a>
<a class="sourceLine" id="cb3-9" title="9"></a>
<a class="sourceLine" id="cb3-10" title="10">  <span class="co">///set_id:subset id, type:subset 类型，time_step:输出间隔，time:输出间隔</span></a>
<a class="sourceLine" id="cb3-11" title="11">  <span class="co">///用于h5part输出（多个不同set_id需输出时，多次调用该函数）</span></a>
<a class="sourceLine" id="cb3-12" title="12">  <span class="dt">void</span> registerSetByStep(<span class="at">const</span> <span class="dt">int</span> set_id, <span class="at">const</span> SetType type,<span class="dt">int</span> time_step);</a>
<a class="sourceLine" id="cb3-13" title="13">  <span class="dt">void</span> registerSetByTime(<span class="at">const</span> <span class="dt">int</span> set_id, <span class="at">const</span> SetType type,scalar time);</a>
<a class="sourceLine" id="cb3-14" title="14"></a>
<a class="sourceLine" id="cb3-15" title="15">  <span class="co">///id: 输出点编号，type:输出点类型，</span></a>
<a class="sourceLine" id="cb3-16" title="16">  <span class="co">///用于csv输出（每个点一个文件）（该函数可多次调用，不同采样点设置不同输出间隔）</span></a>
<a class="sourceLine" id="cb3-17" title="17">  <span class="dt">void</span> registerByStep(<span class="dt">int</span> id, <span class="at">const</span> SetType type,<span class="dt">int</span> time_step);</a>
<a class="sourceLine" id="cb3-18" title="18">  <span class="dt">void</span> registerByTime(<span class="dt">int</span> id, <span class="at">const</span> SetType type,scalar time);</a>
<a class="sourceLine" id="cb3-19" title="19"></a>
<a class="sourceLine" id="cb3-20" title="20">  <span class="co">/// 注册场变量（默认Region中所有相关场），要求每个注册过的id都要调用该函数</span></a>
<a class="sourceLine" id="cb3-21" title="21">  <span class="dt">void</span> registerSetPlotFields(<span class="at">const</span> <span class="dt">int</span> set_id, <span class="at">const</span> SetType type);</a>
<a class="sourceLine" id="cb3-22" title="22">  <span class="dt">void</span> registerPlotFields(<span class="at">const</span> <span class="dt">int</span> id, <span class="at">const</span> SetType type);</a>
<a class="sourceLine" id="cb3-23" title="23">  <span class="co">///相对于上面的接口，增加了field_ids用于指定输出的场变量（注意场的id对应的场类型与type要对应）</span></a>
<a class="sourceLine" id="cb3-24" title="24">  <span class="dt">void</span> registerSetPlotFields(<span class="at">const</span> <span class="dt">int</span> set_id, <span class="at">const</span> SetType type,<span class="bu">std::</span>vector&lt;<span class="dt">int</span>&gt; &amp;field_ids);</a>
<a class="sourceLine" id="cb3-25" title="25">  <span class="dt">void</span> registerPlotFields(<span class="at">const</span> <span class="dt">int</span> id, <span class="at">const</span> SetType type,<span class="bu">std::</span>vector&lt;<span class="dt">int</span>&gt; &amp;field_ids);</a>
<a class="sourceLine" id="cb3-26" title="26"></a>
<a class="sourceLine" id="cb3-27" title="27">  <span class="co">///为已经调用过registerByStep/Time的id注册一个已知函数f(x,t)场用于和其他场变量对比，x为点的坐标,t为模拟时间，模板T可为label/scalar/Tensor1</span><span class="kw">&lt;scalar&gt;</span><span class="co">/Tensor1</span><span class="kw">&lt;label&gt;</span><span class="co">类型</span></a>
<a class="sourceLine" id="cb3-28" title="28">  <span class="kw">template</span>&lt;<span class="kw">typename</span> T&gt;</a>
<a class="sourceLine" id="cb3-29" title="29">  <span class="dt">void</span> registerSetVariable(<span class="at">const</span> <span class="dt">int</span> set_id, <span class="at">const</span> SetType type,<span class="at">const</span> string &amp;VariableName, <span class="at">const</span> Coefficient&lt;T&gt;&amp; f);</a>
<a class="sourceLine" id="cb3-30" title="30">  <span class="kw">template</span>&lt;<span class="kw">typename</span> T&gt;</a>
<a class="sourceLine" id="cb3-31" title="31">  <span class="dt">void</span> registerVariable(<span class="at">const</span> <span class="dt">int</span> id, <span class="at">const</span> SetType type,<span class="at">const</span> string &amp;VariableName, <span class="at">const</span> Coefficient&lt;T&gt;&amp; f);</a>
<a class="sourceLine" id="cb3-32" title="32"></a>
<a class="sourceLine" id="cb3-33" title="33">  <span class="co">/*!</span></a>
<a class="sourceLine" id="cb3-34" title="34"><span class="co">   * </span><span class="an">@brief</span><span class="co"> 输出曲线量到缓存</span></a>
<a class="sourceLine" id="cb3-35" title="35"><span class="co">   * </span><span class="an">@param</span><span class="co"> </span><span class="cv">time_step</span><span class="co">        输出时的时间步</span></a>
<a class="sourceLine" id="cb3-36" title="36"><span class="co">   * </span><span class="an">@param</span><span class="co"> </span><span class="cv">simulation_time</span><span class="co">  输出时的物理时刻</span></a>
<a class="sourceLine" id="cb3-37" title="37"><span class="co">   * */</span></a>
<a class="sourceLine" id="cb3-38" title="38">  <span class="dt">void</span> writeData(<span class="dt">int</span> time_step, scalar simulation_time);</a>
<a class="sourceLine" id="cb3-39" title="39"></a>
<a class="sourceLine" id="cb3-40" title="40">  <span class="co">/*!</span></a>
<a class="sourceLine" id="cb3-41" title="41"><span class="co">  * </span><span class="an">@brief</span><span class="co"> 将缓存的曲线量输出到数据文件.</span></a>
<a class="sourceLine" id="cb3-42" title="42"><span class="co">  */</span></a>
<a class="sourceLine" id="cb3-43" title="43">  <span class="dt">void</span> flushData();</a></code></pre></div>
<h3 id="内部接口">内部接口</h3>
<ul>
<li>h5part相关使用接口（参考testH5Part.cpp案例与h5part文件夹的代码）</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb4-1" title="1">H5PartFile *H5PartOpenFileParallel(</a>
<a class="sourceLine" id="cb4-2" title="2">    <span class="dt">const</span> <span class="dt">char</span> *filename, <span class="co">/*!&lt; [in] The name of the data file to open. */</span></a>
<a class="sourceLine" id="cb4-3" title="3">    <span class="dt">const</span> <span class="dt">char</span> flags,     <span class="co">/*!&lt; [in] The access mode for the file. */</span></a>
<a class="sourceLine" id="cb4-4" title="4">    MPI_Comm comm         <span class="co">/*!&lt; [in] MPI communicator */</span></a>
<a class="sourceLine" id="cb4-5" title="5">);</a>
<a class="sourceLine" id="cb4-6" title="6">h5part_int64_t H5PartSetStep(</a>
<a class="sourceLine" id="cb4-7" title="7">    H5PartFile *f,            <span class="co">/*!&lt; [in]  Handle to open file */</span></a>
<a class="sourceLine" id="cb4-8" title="8">    <span class="dt">const</span> h5part_int64_t step <span class="co">/*!&lt; [in]  Time-step to set. */</span></a>
<a class="sourceLine" id="cb4-9" title="9">) ;</a>
<a class="sourceLine" id="cb4-10" title="10">h5part_int64_t H5PartSetNumParticles(</a>
<a class="sourceLine" id="cb4-11" title="11">    H5PartFile *f,                  <span class="co">/*!&lt; [in] Handle to open file */</span></a>
<a class="sourceLine" id="cb4-12" title="12">    <span class="dt">const</span> h5part_int64_t nparticles <span class="co">/*!&lt; [in] Number of particles */</span></a>
<a class="sourceLine" id="cb4-13" title="13">) ;</a>
<a class="sourceLine" id="cb4-14" title="14">h5part_int64_t H5PartWriteDataFloat64(</a>
<a class="sourceLine" id="cb4-15" title="15">    H5PartFile *f,                <span class="co">/*!&lt; [in] Handle to open file */</span></a>
<a class="sourceLine" id="cb4-16" title="16">    <span class="dt">const</span> <span class="dt">char</span> *name,             <span class="co">/*!&lt; [in] Name to associate array with */</span></a>
<a class="sourceLine" id="cb4-17" title="17">    <span class="dt">const</span> h5part_float64_t *array <span class="co">/*!&lt; [in] Array to commit to disk */</span></a>
<a class="sourceLine" id="cb4-18" title="18">) ;</a>
<a class="sourceLine" id="cb4-19" title="19">h5part_int64_t H5PartWriteDataInt32(</a>
<a class="sourceLine" id="cb4-20" title="20">    H5PartFile *f,              <span class="co">/*!&lt; [in] Handle to open file */</span></a>
<a class="sourceLine" id="cb4-21" title="21">    <span class="dt">const</span> <span class="dt">char</span> *name,           <span class="co">/*!&lt; [in] Name to associate array with */</span></a>
<a class="sourceLine" id="cb4-22" title="22">    <span class="dt">const</span> h5part_int32_t *array <span class="co">/*!&lt; [in] Array to commit to disk */</span></a>
<a class="sourceLine" id="cb4-23" title="23">) ;</a>
<a class="sourceLine" id="cb4-24" title="24">h5part_int64_t H5PartCloseFile(</a>
<a class="sourceLine" id="cb4-25" title="25">    H5PartFile *f <span class="co">/*!&lt; [in] filehandle of the file to close */</span></a>
<a class="sourceLine" id="cb4-26" title="26">) ;</a>
<a class="sourceLine" id="cb4-27" title="27"></a>
<a class="sourceLine" id="cb4-28" title="28">...</a></code></pre></div>
<ul>
<li><p>HDFTool相关接口</p></li>
<li><p>ustrMesh获取数据相关接口</p></li>
<li><p>Region中获取场的相关接口</p></li>
</ul>
<p>（注意Region不能直接知道每个场的类型，因为是通过void*指针存的，需要用fieldsType_的type_index进行判断，详见hsfRegion.cpp的CASTOP宏）</p>
<ul>
<li>subset相关接口</li>
</ul>
<h3 id="相关链接">相关链接</h3>
<p><a href="https://github.com/zoziha/h5part" class="uri">https://github.com/zoziha/h5part</a><br />
<a href="https://dav.lbl.gov/archive/Research/AcceleratorSAPP/index.html" class="uri">https://dav.lbl.gov/archive/Research/AcceleratorSAPP/index.html</a></p>
